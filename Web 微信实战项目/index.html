<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Gemini æç®€å¾®ä¿¡</title>
    <style>
      body {
        font-family: -apple-system, sans-serif;
        background: #f0f0f0;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        list-style: none;
        margin: 0;
      }
      #messages li {
        margin-bottom: 15px;
        max-width: 80%;
      }
      .msg-box {
        background: white;
        padding: 10px;
        border-radius: 8px;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .system-msg {
        text-align: center;
        color: #888;
        font-size: 12px;
        max-width: 100% !important;
      }
      #form-container {
        background: #f7f7f7;
        padding: 10px;
        border-top: 1px solid #ddd;
      }
      #controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        outline: none;
      }
      .emoji-btn {
        font-size: 24px;
        cursor: pointer;
        border: none;
        background: none;
      }
      #file-btn {
        font-size: 20px;
        cursor: pointer;
        color: #666;
      }
      img.chat-img {
        max-width: 200px;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>

    <div id="form-container">
      <div id="emoji-bar" style="margin-bottom: 5px">
        <button class="emoji-btn">ğŸ˜‚</button>
        <button class="emoji-btn">â¤ï¸</button>
        <button class="emoji-btn">ğŸ‘</button>
        <label id="file-btn" title="å‘é€å›¾ç‰‡">
          ğŸ“· <input type="file" id="file-input" hidden accept="image/*"
        /></label>
      </div>
      <form id="form" action="">
        <div id="controls">
          <input id="input" autocomplete="off" placeholder="è¾“å…¥æ¶ˆæ¯..." />
          <button
            type="submit"
            style="
              padding: 10px 20px;
              background: #07c160;
              color: white;
              border: none;
              border-radius: 4px;
            "
          >
            å‘é€
          </button>
        </div>
      </form>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      // 2. è¿æ¥åç«¯ï¼ˆç¡®ä¿ç«¯å£ä¸€è‡´ï¼‰
      const socket = io("http://localhost:3000");

      const nickname = prompt("è¯·è¾“å…¥ä½ çš„å¾®ä¿¡å·:") || "æ–°åŒå­¦";
      socket.emit("set nickname", nickname);

      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");
      const fileInput = document.getElementById("file-input");

      // å‘é€æ–‡å­—
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit("chat message", { type: "text", content: input.value });
          input.value = "";
        }
      });

      // å‘é€å†…ç½®è¡¨æƒ…
      document.querySelectorAll(".emoji-btn").forEach((btn) => {
        btn.onclick = () => {
          socket.emit("chat message", { type: "text", content: btn.innerText });
        };
      });

      // å‘é€æœ¬åœ°å›¾ç‰‡ (Base64)
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            socket.emit("chat message", {
              type: "img",
              content: event.target.result,
            });
          };
          reader.readAsDataURL(file);
        }
      };

      // æ¸²æŸ“æ¶ˆæ¯
      socket.on("chat message", (msg) => {
        const item = document.createElement("li");
        if (msg.user === "ç³»ç»Ÿ") {
          item.className = "system-msg";
          item.innerText = msg.content;
        } else {
          const contentHTML =
            msg.type === "img"
              ? `<img src="${msg.content}" class="chat-img" onclick="window.open(this.src)">`
              : `<span>${msg.content}</span>`;

          item.innerHTML = `
                    <div style="font-size: 12px; color: #666; margin-bottom: 2px;">${msg.user}</div>
                    <div class="msg-box">${contentHTML}</div>
                `;
        }
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
      });
    </script>
  </body>
</html>
