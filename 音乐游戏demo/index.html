<!doctype html>
<html>
  <head>
    <title>Web Band MVP - Fix Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.22/Tone.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        background: #1a1a1a;
        color: white;
        font-family: sans-serif;
        text-align: center;
      }
      .lane-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      canvas {
        background: #000;
        border: 2px solid #444;
        border-radius: 8px;
      }
      .controls {
        margin: 20px;
        padding: 20px;
        border: 1px dashed #666;
        background: #222;
      }
      button {
        padding: 12px 24px;
        cursor: pointer;
        background: #444;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
      }
      button:active {
        background: #28a745;
      }
      #status-log {
        height: 80px;
        overflow-y: auto;
        font-size: 14px;
        color: #aaa;
        margin-top: 10px;
        border-top: 1px solid #333;
        padding-top: 10px;
      }
      .highlight {
        color: #28a745;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¸ ç½‘é¡µè”æœºä¹é˜Ÿ (3100 ä¿®å¤ç‰ˆ)</h1>

    <div class="controls">
      <div id="step1">
        <h3>ç¬¬ä¸€æ­¥ï¼šæ¿€æ´»å£°éŸ³å¼•æ“</h3>
        <button id="start-btn">ç‚¹å‡»æ¿€æ´»éŸ³é¢‘ (å¿…é¡»ç‚¹å‡»!)</button>
      </div>

      <div id="step2" style="display: none">
        <h3>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä½ çš„ä¹å™¨å¹¶å¼€å§‹æ¼”å¥</h3>
        <p>é€‰å¥½åï¼ŒæŒ‰é”®ç›˜ <span class="highlight">ä»»æ„é”®</span> å‘å£°</p>
        <button onclick="setRole('piano')">é’¢ç´ (A)</button>
        <button onclick="setRole('drum')">æ¶å­é¼“ (B)</button>
        <button onclick="setRole('synth')">åˆæˆå™¨ (C)</button>
      </div>
    </div>

    <div class="lane-container">
      <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <div id="status-log">ç­‰å¾…è¿æ¥æœåŠ¡å™¨...</div>

    <script>
      // 1. æ˜ç¡®æŒ‡å‘ 3100 ç«¯å£ï¼Œè§£å†³ 5501 è·¨åŸŸé—®é¢˜
      const socket = io("http://127.0.0.1:3100");

      let myRole = null;
      let isReady = false;

      // çŠ¶æ€æ—¥å¿—
      const log = (msg) => {
        const div = document.getElementById("status-log");
        div.innerHTML =
          `<div>${new Date().toLocaleTimeString()}: ${msg}</div>` +
          div.innerHTML;
      };

      socket.on("connect", () =>
        log('<span class="highlight">âœ… å·²è¿æ¥åˆ° 3100 ç«¯å£æœåŠ¡å™¨</span>'),
      );
      socket.on("connect_error", () =>
        log(
          '<span style="color:red">âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ server.js æ˜¯å¦è¿è¡Œ</span>',
        ),
      );

      // 2. éŸ³è‰²åˆå§‹åŒ–
      const sounds = {
        piano: new Tone.Synth({ oscillator: { type: "sine" } }).toDestination(),
        drum: new Tone.MembraneSynth().toDestination(),
        synth: new Tone.AMSynth().toDestination(),
      };

      // 3. å¤„ç†ç‚¹å‡»æ¿€æ´» (è§£å†³ AudioContext æŠ¥é”™)
      document.getElementById("start-btn").onclick = async () => {
        try {
          await Tone.start();
          isReady = true;
          log("âœ… éŸ³é¢‘å¼•æ“å·²å¯åŠ¨ï¼");
          document.getElementById("step1").style.display = "none";
          document.getElementById("step2").style.display = "block";
        } catch (e) {
          log("å¯åŠ¨å¤±è´¥: " + e);
        }
      };

      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      let notes = [];
      const roleConfig = {
        piano: { x: 80, color: "#4CAF50", note: "C4" },
        drum: { x: 200, color: "#FF5722", note: "C2" },
        synth: { x: 320, color: "#2196F3", note: "G4" },
      };

      function setRole(role) {
        myRole = role;
        log(`å·²åˆ‡æ¢è§’è‰²ä¸º: ${role}`);
      }

      // æŒ‰é”®å‘é€
      window.onkeydown = (e) => {
        if (!myRole || !isReady) return;
        socket.emit("play_note", { role: myRole });
      };

      // æ¥æ”¶åŒæ­¥
      socket.on("listen_note", (data) => {
        const config = roleConfig[data.role];
        if (!config) return;

        // åªæœ‰æ¿€æ´»äº†å£°éŸ³çš„äººæ‰èƒ½å¬åˆ°
        if (isReady) {
          sounds[data.role].triggerAttackRelease(config.note, "8n");
        }

        notes.push({ x: config.x, y: 0, color: config.color });
        log(`ä¹æ‰‹ [${data.role}] æ¼”å¥äº†éŸ³ç¬¦`);
      });

      // æ¸²æŸ“å¾ªç¯
      function draw() {
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#333";
        ctx.strokeRect(0, 350, 400, 1);

        notes.forEach((n, i) => {
          n.y += 5;
          ctx.fillStyle = n.color;
          ctx.beginPath();
          ctx.arc(n.x, n.y, 15, 0, Math.PI * 2);
          ctx.fill();
          if (n.y > 450) notes.splice(i, 1);
        });
        requestAnimationFrame(draw);
      }
      draw();
    </script>
  </body>
</html>
